@Library('share_lib@main') _

pipeline {
    agent any

    parameters {
        choice(name: 'DEV_BRANCH', choices: ['dev1', 'dev2', 'dev3'], description: 'Select developer branch')
    }

    environment {
        IMAGE_PREFIX = "ganesh6498"
        DEPLOY_YAML = "deployment.yaml"
    }

    stages {

        stage('Docker Login') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-hub',
                                                  usernameVariable: 'DOCKER_USER',
                                                  passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                    echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                    '''
                }
            }
        }

        stage("Build and Push Docker Image") {
            steps {
                script {
                    def dockerfile = ''
                    def imageName = ''
                    if (params.DEV_BRANCH == 'dev1') {
                        dockerfile = 'Dockerfile'
                        imageName = 'dev1-app'
                    } else if (params.DEV_BRANCH == 'dev2') {
                        dockerfile = 'web1.Dockerfile'
                        imageName = 'dev2-app'
                    } else if (params.DEV_BRANCH == 'dev3') {
                        dockerfile = 'web2.Dockerfile'
                        imageName = 'dev3-app'
                    }

                    env.IMAGE_NAME = imageName

                    sh """
                    docker build -f ${dockerfile} -t ${IMAGE_PREFIX}/${imageName}:${BUILD_NUMBER} .
                    docker push ${IMAGE_PREFIX}/${imageName}:${BUILD_NUMBER}
                    sed -i 's|image: .*|image: ${IMAGE_PREFIX}/${imageName}:${BUILD_NUMBER}|' ${DEPLOY_YAML}
                    """
                }
            }
        }

        stage("See the Variable") {
            steps {
                script {
                    def branch = params.DEV_BRANCH
                    echo "Pushing changes to branch: ${branch}"

                    sh '''
                    git config --global user.email "ganeshreddy7610@gmail.com"
                    git config --global user.name "ganesh-redy"
                    '''
                }
            }
        }

        stage('Push to Branch') {
    steps {
        withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
    script {
        sh """
            # Cleanup any previous temp directory
            rm -rf git-temp

            # Clone using token (you can use any GitHub username, or just 'git')
            git clone https://git:${GITHUB_TOKEN}@github.com/ganesh-redy/gitops-test2.git git-temp
            cd git-temp

            git checkout ${params.DEV_BRANCH} || git checkout -b ${params.DEV_BRANCH}

            cp ../${DEPLOY_YAML} .

            git config user.email "ganeshreddy7610@gmail.com"
            git config user.name "ganesh-redy"

            git add ${DEPLOY_YAML}
            git commit -m "Update from pipeline build ${BUILD_NUMBER}" || echo "No changes to commit"

            # Push with username and token in URL
            git push https://git:${GITHUB_TOKEN}@github.com/ganesh-redy/gitops-test2.git ${params.DEV_BRANCH}
        """
    }
}

    }
}

    }
}
